# 1단계: 인증 및 기본 CRUD

## 2. 데이터 영속성 및 보안 설정

`UserAccount` 엔티티를 데이터베이스에 저장하고 조회하기 위한 `Repository` 인터페이스를 정의하고, Spring Security를 설정하여 애플리케이션의 보안 체계를 구축합니다.

### 1. `UserAccountRepository` 인터페이스

Spring Data JPA는 `JpaRepository` 인터페이스를 상속받는 것만으로도 기본적인 CRUD(Create, Read, Update, Delete) 메서드를 자동으로 생성해줍니다.

- `JpaRepository<UserAccount, Long>`: `UserAccount` 엔티티를 관리하며, 기본 키의 타입은 `Long`임을 의미합니다.
- **Query Method**: 정해진 규칙에 따라 메서드 이름을 작성하면, Spring Data JPA가 메서드 이름을 분석하여 자동으로 쿼리를 생성합니다. `findByUsername`은 `WHERE username = ?` 조건의 쿼리를 실행합니다.
- `Optional<UserAccount>`: 조회 결과가 존재하지 않을 수 있음을 명시적으로 표현합니다. `null`을 직접 다루는 것보다 안전하며, `orElseThrow()`, `ifPresent()` 등 다양한 메서드를 활용할 수 있습니다.

```java
// src/main/java/com/example/boardpjt/model/repository/UserAccountRepository.java

package com.example.boardpjt.model.repository;

import com.example.boardpjt.model.entity.UserAccount;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface UserAccountRepository extends JpaRepository<UserAccount, Long> {

    /**
     * 사용자명으로 사용자 계정을 조회하는 메서드
     * Spring Data JPA의 Query Method 기능을 활용하여 자동 쿼리 생성
     *
     * @param username 조회할 사용자명
     * @return Optional<UserAccount> - 조회된 사용자 계정 (존재하지 않을 수 있음)
     */
    Optional<UserAccount> findByUsername(String username);
}
```

### 2. `SecurityConfig` - 보안 설정 클래스

`SecurityConfig`는 Spring Security의 동작을 커스터마이징하는 핵심 설정 클래스입니다. 여기서는 비밀번호 암호화, 인증 관리, URL별 접근 권한, 필터 체인 등을 설정합니다.

#### `PasswordEncoder` 빈 등록

사용자의 비밀번호를 안전하게 저장하기 위해 암호화는 필수입니다. `PasswordEncoder`를 Spring 컨테이너의 빈(Bean)으로 등록하여 프로젝트 전역에서 사용할 수 있도록 합니다. `BCryptPasswordEncoder`는 현재 가장 널리 사용되는 안전한 해시 알고리즘 중 하나입니다.

```java
// src/main/java/com/example/boardpjt/config/SecurityConfig.java

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {
    // ... (다른 필드)

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

#### `AuthenticationManager` 빈 등록

`AuthenticationManager`는 사용자의 로그인 요청 시 인증을 처리하는 핵심 컴포넌트입니다. Spring Security 5.x 이상에서는 `AuthenticationConfiguration`을 통해 `AuthenticationManager`를 빈으로 노출시켜야 합니다.

```java
// src/main/java/com/example/boardpjt/config/SecurityConfig.java

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {
    // ... (다른 필드)

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration configuration) throws Exception {
        return configuration.getAuthenticationManager();
    }
}
```

#### `SecurityFilterChain` 설정

`SecurityFilterChain`은 HTTP 요청에 대한 보안 처리를 정의하는 필터 체인입니다. JWT 기반 인증을 위해 기존의 세션 기반 설정을 비활성화하고, URL별 접근 권한을 설정하며, 직접 만든 `JwtFilter`를 등록합니다.

- **기본 설정 비활성화**:
  - `csrf(AbstractHttpConfigurer::disable)`: CSRF(Cross-Site Request Forgery) 보호를 비활성화합니다. JWT는 상태를 저장하지 않으므로 일반적으로 CSRF 공격에 안전합니다.
  - `formLogin(AbstractHttpConfigurer::disable)`: Spring Security가 제공하는 기본 로그인 폼을 비활성화합니다.
  - `httpBasic(AbstractHttpConfigurer::disable)`: HTTP Basic 인증을 비활성화합니다.
  - `sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))`: 세션을 사용하지 않고, 모든 요청을 상태 없이(stateless) 처리하도록 설정합니다. JWT 인증의 핵심입니다.
- **URL별 접근 권한 설정**:
  - `requestMatchers("/", "/auth/**").permitAll()`: 홈페이지(`/`)와 인증 관련 경로(`/auth/**`)는 모든 사용자가 접근할 수 있도록 허용합니다.
  - `anyRequest().authenticated()`: 그 외의 모든 요청은 인증된 사용자만 접근할 수 있도록 설정합니다.
- **필터 추가**:
  - `addFilterBefore(new JwtFilter(...), UsernamePasswordAuthenticationFilter.class)`: 직접 구현한 `JwtFilter`를 `UsernamePasswordAuthenticationFilter` 앞에 추가하여, 모든 요청에 대해 JWT 토큰을 먼저 검증하도록 합니다.

```java
// src/main/java/com/example/boardpjt/config/SecurityConfig.java

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final CustomUserDetailsService customUserDetailsService;
    private final JwtUtil jwtUtil;

    // ... (PasswordEncoder, AuthenticationManager 빈)

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

        // 기본 보안 설정 비활성화
        http.csrf(AbstractHttpConfigurer::disable)
                .formLogin(AbstractHttpConfigurer::disable)
                .httpBasic(AbstractHttpConfigurer::disable)
                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS));

        // URL별 접근 권한 설정
        http.authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/auth/**", "/posts/**").permitAll() // 게시판 관련 경로 추가
                .requestMatchers("/admin/**").hasRole("ADMIN") // 관리자 페이지는 ADMIN 역할만
                .anyRequest().authenticated()
        );

        // JWT 필터 추가
        http.addFilterBefore(new JwtFilter(customUserDetailsService, jwtUtil), UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
}
```

이제 데이터베이스 접근을 위한 `Repository`와 애플리케이션의 보안을 책임지는 `SecurityConfig` 설정이 완료되었습니다. 다음 단계에서는 JWT 토큰을 생성하고 검증하는 로직과 실제 인증을 처리하는 서비스들을 구현합니다.
