# 1단계: 인증 및 기본 CRUD

## 4. 인증 컨트롤러, 필터 및 뷰

사용자의 회원가입 및 로그인 요청을 직접 처리하는 `AuthController`, 모든 요청에서 JWT 토큰을 검증하는 `JwtFilter`, 그리고 사용자에게 보여질 HTML 뷰(View) 파일을 작성합니다.

### 1. `JwtFilter` - JWT 토큰 검증 필터

`JwtFilter`는 클라이언트의 모든 요청에 대해 가장 먼저 실행되는 필터 중 하나로, HTTP 요청에서 JWT 토큰을 추출하고 유효성을 검증하여 사용자를 인증하는 핵심적인 역할을 합니다. `OncePerRequestFilter`를 상속받아 요청당 한 번만 실행되도록 보장합니다.

- **토큰 추출**: `CookieUtil` (또는 `Authorization` 헤더)을 통해 `access_token`을 요청에서 추출합니다.
- **토큰 유효성 검증**: `jwtUtil.validateToken()`을 통해 토큰이 유효한지(만료되지 않았는지, 서명이 올바른지 등) 확인합니다.
- **사용자 정보 조회**: 토큰이 유효하면 `jwtUtil.getUsername()`으로 사용자명을 추출하고, `customUserDetailsService.loadUserByUsername()`을 통해 `UserDetails` 객체를 조회합니다.
- **`SecurityContext`에 인증 정보 저장**: 조회된 `UserDetails`를 바탕으로 `UsernamePasswordAuthenticationToken`을 생성하고, `SecurityContextHolder.getContext().setAuthentication()`을 통해 현재 요청의 보안 컨텍스트에 인증 정보를 저장합니다. 이 작업이 완료되면, 해당 요청은 '인증된' 상태가 되며, 이후 컨트롤러 등에서 `@AuthenticationPrincipal` 이나 `Authentication` 객체를 통해 사용자 정보에 접근할 수 있습니다.

```java
// src/main/java/com/example/boardpjt/filter/JwtFilter.java

package com.example.boardpjt.filter;

import com.example.boardpjt.service.CustomUserDetailsService;
import com.example.boardpjt.util.CookieUtil;
import com.example.boardpjt.util.JwtUtil;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;

@RequiredArgsConstructor
public class JwtFilter extends OncePerRequestFilter {

    private final CustomUserDetailsService customUserDetailsService;
    private final JwtUtil jwtUtil;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        // 1. 쿠키에서 JWT 토큰 추출
        String token = CookieUtil.findCookie(request, "access_token");

        // 2. 토큰이 없거나 유효하지 않으면 다음 필터로 전달
        if (token == null || !jwtUtil.validateToken(token)) {
            filterChain.doFilter(request, response);
            return;
        }

        // 3. 토큰이 유효하면 사용자 인증 처리
        String username = jwtUtil.getUsername(token);
        UserDetails userDetails = customUserDetailsService.loadUserByUsername(username);

        // SecurityContext에 인증 정보 저장
        UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(
                userDetails, null, userDetails.getAuthorities());
        SecurityContextHolder.getContext().setAuthentication(authentication);

        filterChain.doFilter(request, response);
    }
}
```

### 2. `AuthController` - 인증 요청 처리 컨트롤러

`AuthController`는 `/register`, `/login`, `/logout` 등 인증과 관련된 HTTP 요청을 처리하고, 적절한 뷰를 반환하거나 리다이렉트합니다.

- **`registerForm()`**: `GET /auth/register` 요청을 받아 회원가입 폼(`register.html`)을 보여줍니다.
- **`register()`**: `POST /auth/register` 요청을 받아 `userAccountService.register()`를 호출하여 회원가입을 처리하고, 성공 시 로그인 페이지로 리다이렉트합니다.
- **`loginForm()`**: `GET /auth/login` 요청을 받아 로그인 폼(`login.html`)을 보여줍니다.
- **`login()`**: `POST /auth/login` 요청을 처리합니다.
  - `authenticationManager.authenticate()`: Spring Security의 `AuthenticationManager`를 통해 사용자 인증을 시도합니다. `CustomUserDetailsService`가 내부적으로 호출됩니다.
  - 인증에 성공하면 `jwtUtil.generateToken()`으로 Access Token과 Refresh Token을 발급합니다.
  - `CookieUtil.createCookie()`를 사용하여 발급된 토큰을 HTTP 쿠키에 담아 클라이언트에게 전송합니다.
  - 로그인 성공 후 마이페이지(`/my-page`)로 리다이렉트합니다.
  - 인증에 실패하면 `RedirectAttributes`를 통해 에러 메시지를 전달하며 로그인 페이지로 다시 리다이렉트합니다.
- **`logout()`**: `POST /auth/logout` 요청을 처리합니다.
  - `CookieUtil.deleteCookie()`를 사용하여 클라이언트의 토큰 쿠키를 삭제합니다.
  - Redis에 저장된 Refresh Token을 삭제하여 서버 측에서도 세션을 무효화합니다.
  - 로그아웃 후 홈페이지(`/`)로 리다이렉트합니다.

```java
// src/main/java/com/example/boardpjt/controller/AuthController.java

@Controller
@RequiredArgsConstructor
@RequestMapping("/auth")
public class AuthController {

    private final UserAccountService userAccountService;
    private final AuthenticationManager authenticationManager;
    private final JwtUtil jwtUtil;
    private final RefreshTokenRepository refreshTokenRepository;

    @GetMapping("/register")
    public String registerForm() {
        return "register";
    }

    @PostMapping("/register")
    public String register(@RequestParam String username, @RequestParam String password) {
        userAccountService.register(username, password);
        return "redirect:/auth/login";
    }

    @GetMapping("/login")
    public String loginForm() {
        return "login";
    }

    @PostMapping("/login")
    public String login(@RequestParam String username, @RequestParam String password, HttpServletResponse response, RedirectAttributes redirectAttributes) {
        try {
            Authentication authentication = authenticationManager.authenticate(
                    new UsernamePasswordAuthenticationToken(username, password)
            );
            String role = authentication.getAuthorities().iterator().next().getAuthority();

            String accessToken = jwtUtil.generateToken(username, role, false);
            String refreshTokenValue = jwtUtil.generateToken(username, role, true);

            // Redis에 Refresh Token 저장
            RefreshToken refreshToken = new RefreshToken(username, refreshTokenValue);
            refreshTokenRepository.save(refreshToken);

            // 쿠키 생성 및 추가
            CookieUtil.createCookie(response, "access_token", accessToken, (int) (jwtUtil.getAccessExpiry() / 1000));
            CookieUtil.createCookie(response, "refresh_token", refreshTokenValue, (int) (jwtUtil.getRefreshExpiry() / 1000));

            return "redirect:/my-page";
        } catch (Exception e) {
            redirectAttributes.addFlashAttribute("error", "아이디 또는 비밀번호가 잘못되었습니다.");
            return "redirect:/auth/login";
        }
    }

    @PostMapping("/logout")
    public String logout(HttpServletRequest request, HttpServletResponse response) {
        String refreshTokenValue = CookieUtil.findCookie(request, "refresh_token");
        if (refreshTokenValue != null) {
            refreshTokenRepository.findByRefreshToken(refreshTokenValue).ifPresent(refreshTokenRepository::delete);
        }

        CookieUtil.deleteCookie(response, "access_token");
        CookieUtil.deleteCookie(response, "refresh_token");

        return "redirect:/";
    }
}
```

### 3. 뷰(View) 파일

Thymeleaf 템플릿 엔진을 사용하여 사용자에게 보여질 HTML 파일을 작성합니다.

#### `login.html`

- 로그인 폼을 제공합니다.
- `th:if="${error}"`: `AuthController`에서 전달된 에러 메시지가 있을 경우에만 에러 메시지를 표시합니다.

```html
<!-- src/main/resources/templates/login.html -->

<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>로그인</title>
  </head>
  <body>
    <h1>로그인</h1>
    <p th:if="${error}" th:text="${error}" style="color: red;"></p>
    <form th:action="@{/auth/login}" method="post">
      <input name="username" placeholder="ID를 입력해주세요" /> <br />
      <input
        type="password"
        name="password"
        placeholder="암호를 입력해주세요"
      />
      <br />
      <button>로그인</button>
    </form>
    <a th:href="@{/auth/register}">회원가입</a>
  </body>
</html>
```

#### `register.html`

- 회원가입 폼을 제공합니다.

```html
<!-- src/main/resources/templates/register.html -->

<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>회원 가입</title>
  </head>
  <body>
    <h1>회원 가입</h1>
    <form th:action="@{/auth/register}" method="post">
      <input name="username" placeholder="ID를 입력해주세요" /> <br />
      <input
        type="password"
        name="password"
        placeholder="암호를 입력해주세요"
      />
      <br />
      <button>회원 가입</button>
    </form>
  </body>
</html>
```

#### `my-page.html`

- 로그인한 사용자에게 보여지는 페이지입니다.
- `th:text="${username}"`: `MainController`에서 전달된 사용자명을 표시합니다.

```html
<!-- src/main/resources/templates/my-page.html -->

<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>마이페이지</title>
  </head>
  <body>
    <h1>마이페이지</h1>
    <p><span th:text="${username}"></span>님 반갑습니다!</p>
    <form th:action="@{/auth/logout}" method="post">
      <button>로그아웃</button>
    </form>
  </body>
</html>
```

이것으로 1단계인 기본 인증 기능 구현이 완료되었습니다. 사용자는 회원가입, 로그인, 로그아웃을 할 수 있으며, JWT 토큰을 통해 인증 상태가 관리됩니다.
