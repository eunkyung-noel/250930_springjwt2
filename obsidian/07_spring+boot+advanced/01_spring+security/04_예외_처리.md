# Spring Security 예외 처리

Spring Security는 인증(Authentication) 및 인가(Authorization) 과정에서 발생하는 예외를 처리하기 위한 명확한 메커니즘을 제공합니다. 보안 관련 예외는 일반적인 애플리케이션 예외와 구분하여 처리하는 것이 중요하며, Spring Security는 이를 위해 `AuthenticationException`과 `AccessDeniedException`이라는 두 가지 주요 예외와 각각의 핸들러를 사용합니다.

---

## 1. 주요 보안 예외

### 1.1. `AuthenticationException` (인증 실패)

- **발생 시점**: 사용자의 **인증**에 실패했을 때 발생합니다.
- **주요 원인**:
  - 존재하지 않는 아이디로 로그인을 시도할 때 (`UsernameNotFoundException`)
  - 비밀번호가 일치하지 않을 때 (`BadCredentialsException`)
  - 계정이 잠겼거나 만료되었을 때 (`LockedException`, `AccountExpiredException`)
- **처리 주체**: `AuthenticationEntryPoint`

### 1.2. `AccessDeniedException` (인가 실패)

- **발생 시점**: **인증**은 성공했지만, 해당 리소스에 접근할 **권한**이 없을 때 발생합니다.
- **주요 원인**:
  - `USER` 역할을 가진 사용자가 `ADMIN` 역할이 필요한 `/admin` 페이지에 접근을 시도할 때
- **처리 주체**: `AccessDeniedHandler`

---

## 2. 예외 처리 핸들러

Spring Security는 `exceptionHandling` DSL을 통해 인증 및 인가 실패 시의 동작을 정의할 수 있습니다.

| 핸들러                         | 역할                                                                         | 설명                                                                                                                                       |
| ------------------------------ | ---------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| **`AuthenticationEntryPoint`** | 인증되지 않은 사용자가 보호된 리소스에 접근을 시도할 때 호출됩니다.          | 사용자를 로그인 페이지로 리다이렉트하거나, API 요청의 경우 401 Unauthorized 상태 코드와 함께 에러 메시지를 반환하는 역할을 합니다.         |
| **`AccessDeniedHandler`**      | 인증된 사용자가 자신의 권한을 넘어서는 리소스에 접근을 시도할 때 호출됩니다. | 사용자에게 접근이 거부되었음을 알리는 페이지(예: 403 Forbidden 페이지)로 안내하거나, API 요청의 경우 403 Forbidden 상태 코드를 반환합니다. |

### `exceptionHandling` DSL을 이용한 설정

`SecurityConfig`에서 `http.exceptionHandling(...)`을 사용하여 각 예외에 대한 처리 방식을 설정할 수 있습니다.

**설정 예시**:

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                // ... 인가 규칙 설정 ...
            )
            .exceptionHandling(exception -> exception
                // 1. 인가 실패 시 처리
                .accessDeniedPage("/access-denied") // 접근 거부 페이지로 리다이렉트
                // 또는 커스텀 핸들러 사용
                // .accessDeniedHandler(new CustomAccessDeniedHandler())

                // 2. 인증 실패 시 처리 (주로 formLogin, oauth2Login 등에서 자동으로 처리됨)
                // .authenticationEntryPoint(new CustomAuthenticationEntryPoint())
            );

        // formLogin 설정이 있으면, 인증되지 않은 사용자는 자동으로 로그인 페이지로 리다이렉트되므로
        // authenticationEntryPoint를 명시적으로 설정할 필요가 없는 경우가 많습니다.
        http.formLogin(form -> form.loginPage("/login"));

        return http.build();
    }
}
```

- `accessDeniedPage("/access-denied")`: 인가에 실패했을 때 사용자를 `/access-denied` URL로 리다이렉트시킵니다. 이 URL에 해당하는 컨트롤러와 뷰(HTML 페이지)를 만들어 사용자에게 친절한 안내를 제공할 수 있습니다.

---

## 3. 전역 예외 처리와의 관계 (`@ControllerAdvice`)

`@ControllerAdvice`를 사용한 전역 예외 처리는 Spring MVC 레이어에서 발생하는 예외를 다룹니다. 반면, Spring Security의 예외 처리는 그보다 앞단인 **필터(Filter) 레벨**에서 동작합니다.

- **Spring Security 예외**: `AuthenticationException`, `AccessDeniedException` 등은 `DispatcherServlet`에 도달하기 전, 보안 필터 체인에서 발생합니다. 따라서 `@ControllerAdvice`로는 기본적으로 잡을 수 없습니다. 이들은 `AuthenticationEntryPoint`와 `AccessDeniedHandler`를 통해 처리해야 합니다.
- **비즈니스 로직 예외**: 컨트롤러 메서드 내부에서 발생하는 예외(예: `IllegalArgumentException`)는 `@ControllerAdvice`를 통해 처리할 수 있습니다.

**흐름 요약**:

1. 클라이언트 요청
2. Spring Security 필터 체인
   - 인증/인가 실패? → `AuthenticationEntryPoint` / `AccessDeniedHandler` 실행 → 응답 종료
   - 인증/인가 성공? → 다음 단계로 진행
3. `DispatcherServlet`
4. 컨트롤러 메서드 실행
   - 비즈니스 예외 발생? → `@ControllerAdvice` 실행 → 응답 종료
   - 정상 처리 → 뷰 렌더링 또는 데이터 반환

이처럼 Spring Security는 보안 관련 예외를 전문적으로 처리하는 명확한 진입점을 제공하여, 애플리케이션의 다른 예외 처리 로직과 역할을 분리하고 코드를 체계적으로 관리할 수 있게 해줍니다.
